@page "/libros"
@inject LibroService libroService
@using BlazorWebAppMovies.Models
@using System.IO

<div class="contenedor-gestion-libros">
    <h3>Gestionar Libros</h3>
    <EditForm Model="@nuevoLibro" OnValidSubmit="@GuardarLibro" class="formulario-libro">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="campo-formulario">
            <label for="titulo">Título:</label>
            <InputText id="titulo" @bind-Value="nuevoLibro.Titulo" class="input-text" />
        </div>

        <div class="campo-formulario">
            <label for="autor">Autor:</label>
            <InputText id="autor" @bind-Value="nuevoLibro.Autor" class="input-text" />
        </div>

        <div class="campo-formulario">
            <label for="isbn">ISBN:</label>
            <InputText id="isbn" @bind-Value="nuevoLibro.ISBN" class="input-text" />
        </div>

        <div class="campo-formulario">
            <label for="estado">Disponible para Préstamo:</label>
            <InputCheckbox id="estado" @bind-Value="nuevoLibro.DisponiblePrestamo" class="input-checkbox" />
        </div>

        <div class="campo-formulario">
            <label for="portada">Portada:</label>
            <InputFile OnChange="@(async e => await SubirPortada(e))" class="input-file" />
        </div>
        
        <button type="submit" class="btn-guardar">Guardar</button>
        </EditForm>
   </div>
    

@code {
    private Libro nuevoLibro = new Libro();
    private List<Libro> libros;

    protected override async Task OnInitializedAsync()
    {
        libros = (await libroService.GetLibrosAsync()).ToList();
    }

    private async Task SubirPortada(InputFileChangeEventArgs e)
    {
        var archivo = e.File;
        if (archivo != null)
        {
            using var ms = new MemoryStream();
            await archivo.OpenReadStream().CopyToAsync(ms);
            nuevoLibro.Portada = ms.ToArray();
        }
    }

    private async Task GuardarLibro()
    {
        await libroService.AddLibroAsync(nuevoLibro);
        nuevoLibro = new Libro();  // Limpiar el formulario después de guardar
        libros = (await libroService.GetLibrosAsync()).ToList();  // Actualizar la lista de libros
    }
}
